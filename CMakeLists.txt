cmake_minimum_required(VERSION 3.6)
project(StrawberryCodec)
set(CMAKE_CXX_STANDARD 23)
find_package(PkgConfig REQUIRED)


include(ExternalProject)
ExternalProject_Add(FFMPEG
		PREFIX ${CMAKE_CURRENT_BINARY_DIR}/Vendor/FFMPEG
		GIT_REPOSITORY "https://git.ffmpeg.org/ffmpeg.git"
		GIT_TAG "release/6.0"

		CONFIGURE_COMMAND ""
		UPDATE_COMMAND ""
		BUILD_COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/scripts/build_ffmpeg.sh <SOURCE_DIR> <BINARY_DIR>
		INSTALL_COMMAND ""
)


find_path(SODIUM_INCLUDE_DIR REQUIRED NAMES sodium.h
	HINTS /usr/local/include)
find_library(SODIUM_LIBRARY REQUIRED
	NAMES libsodium.a
	HINTS /usr/local/lib
)


if(NOT TARGET StrawberryCore AND EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/../Core AND IS_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/../Core)
	add_subdirectory(../Core ${CMAKE_CURRENT_BINARY_DIR}/Core)
endif()


add_library(StrawberryCodec STATIC
		include/Codec/Audio/Decoder.hpp
		include/Codec/Audio/Encoder.hpp
		include/Codec/Audio/Frame.hpp
		include/Codec/Audio/FrameFormat.hpp
		include/Codec/Audio/FrameResizer.hpp
		include/Codec/Audio/Mixer.hpp
		include/Codec/Audio/Playlist.hpp
		include/Codec/Audio/Resampler.hpp
		include/Codec/CodecParameters.hpp
		include/Codec/Constants.hpp
		include/Codec/MediaFile.hpp
		include/Codec/MediaStream.hpp
		include/Codec/Muxer.hpp
		include/Codec/Packet.hpp
		include/Codec/SodiumEncrypter.hpp
		src/Audio/Decoder.cpp
		src/Audio/Encoder.cpp
		src/Audio/Frame.cpp
		src/Audio/FrameFormat.cpp
		src/Audio/FrameResizer.cpp
		src/Audio/Mixer.cpp
		src/Audio/Playlist.cpp
		src/Audio/Resampler.cpp
		src/MediaFile.cpp
		src/MediaStream.cpp
		src/Muxer.cpp
		src/Packet.cpp
		src/SodiumEncrypter.cpp
)


target_include_directories(StrawberryCodec PUBLIC include ${SODIUM_INCLUDE_DIR})
target_link_libraries(StrawberryCodec PUBLIC StrawberryCore ${SODIUM_LIBRARY})
# We need this for libavfilter
target_compile_definitions(StrawberryCodec PUBLIC __STDC_CONSTANT_MACROS)
add_dependencies(StrawberryCodec FFMPEG)


# FFMPEG Compile Flags
if (${CMAKE_SYSTEM_NAME} MATCHES "Darwin")
	# CFlags options generated by pkg-config for FFMPEG
	target_compile_options(StrawberryCodec PRIVATE "-I${CURRENT_BINARY_DIR}/Vendor/FFMPEG/src/FFMPEG-build/include")
	# Linker arguments generated by pkg-config for FFMPEG
	target_link_libraries(StrawberryCodec PRIVATE "-L${CMAKE_CURRENT_BINARY_DIR}/Vendor/FFMPEG/src/FFMPEG-build/lib -L/usr/local/Cellar/libxcb/1.15_1/lib -L/usr/local/lib -L${CMAKE_CURRENT_BINARY_DIR}/Vendor/FFMPEG/src/FFMPEG-build/lib -L/usr/local/Cellar/libx11/1.8.6/lib -lavdevice -framework Foundation -framework AudioToolbox -framework CoreAudio -lm -framework AVFoundation -framework CoreVideo -framework CoreMedia -framework CoreGraphics -lxcb -lxcb-shm -lxcb-shape -lxcb-xfixes -framework AudioToolbox -pthread -lSDL2 -lavfilter -framework OpenGL -pthread -lm -framework CoreImage -framework AppKit -lavformat -lm -lbz2 -lz -Wl,-framework,CoreFoundation -Wl,-framework,Security -lavcodec -liconv -lm -llzma -framework AudioToolbox -pthread -lz -framework VideoToolbox -framework CoreFoundation -framework CoreMedia -framework CoreVideo -framework CoreServices -lswresample -lm -lswscale -lm -lavutil -pthread -lm -framework VideoToolbox -lX11 -framework CoreFoundation -framework CoreMedia -framework CoreVideo -framework CoreServices")
endif()


add_executable(StrawberryCodecTest test/Main.cpp)
target_link_libraries(StrawberryCodecTest PRIVATE StrawberryCodec)